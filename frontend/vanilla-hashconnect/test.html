<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HashConnect Vanilla JS Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>HashConnect Vanilla JS Test</h1>
    
    <div class="container">
        <h2>Connection Test</h2>
        <div id="status" class="status info">Initializing...</div>
        <button id="connectBtn">Connect Wallet</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
        <div id="accountInfo"></div>
    </div>

    <div class="container">
        <h2>Transaction Test</h2>
        <div>
            <label>From Account: <input type="text" id="fromAccount" value="0.0.12345"></label>
        </div>
        <div>
            <label>To Account: <input type="text" id="toAccount" value="0.0.67890"></label>
        </div>
        <button id="transferBtn" disabled>Send 1 HBAR</button>
        <div id="transactionResult"></div>
    </div>

    <!-- Polyfill for Buffer -->
    <script src="https://unpkg.com/buffer@6.0.3/index.js"></script>
    
    <!-- Hedera SDK -->
    <script src="https://unpkg.com/@hashgraph/sdk@2.41.0/dist/index.web.js"></script>
    
    <!-- HashConnect -->
    <script src="https://unpkg.com/hashconnect@3.0.13/dist/hashconnect.js"></script>

    <script type="module">
        // Set up Buffer polyfill
        window.Buffer = window.Buffer || buffer.Buffer;

        // Configuration
        const env = "testnet";
        const appMetadata = {
            name: "Vanilla JS Test",
            description: "Test HashConnect in vanilla JS",
            icons: [window.location.origin + "/favicon.ico"],
            url: window.location.origin,
        };
        const projectId = "39948bbdaaebec2790629f3e9589793a"; // Get from https://cloud.walletconnect.com/

        // Initialize HashConnect
        const hc = new HashConnect.HashConnect(
            HashgraphSdk.LedgerId.fromString(env),
            projectId,
            appMetadata,
            true
        );

        // Initialize HashConnect
        const hcInitPromise = hc.init();

        // DOM elements
        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const accountInfoEl = document.getElementById('accountInfo');
        const transferBtn = document.getElementById('transferBtn');

        // Update status
        function updateStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }

        // Update account info
        function updateAccountInfo() {
            const accountIds = hc.connectedAccountIds;
            if (accountIds && accountIds.length > 0) {
                accountInfoEl.innerHTML = `
                    <h3>Connected Accounts</h3>
                    <ul>
                        ${accountIds.map(id => `<li>${id.toString()}</li>`).join('')}
                    </ul>
                `;
                transferBtn.disabled = false;
            } else {
                accountInfoEl.innerHTML = '<p>Not connected</p>';
                transferBtn.disabled = true;
            }
        }

        // Connect wallet
        connectBtn.addEventListener('click', async () => {
            try {
                await hcInitPromise;
                hc.openPairingModal();
            } catch (error) {
                updateStatus('Connection failed: ' + error.message, 'error');
            }
        });

        // Disconnect wallet
        disconnectBtn.addEventListener('click', () => {
            hc.disconnect();
        });

        // Send transfer
        document.getElementById('transferBtn').addEventListener('click', async () => {
            const fromAccount = document.getElementById('fromAccount').value;
            const toAccount = document.getElementById('toAccount').value;
            
            if (!fromAccount || !toAccount) {
                alert('Please enter both account IDs');
                return;
            }
            
            try {
                // Create transfer transaction
                const transferTransaction = new HashgraphSdk.TransferTransaction()
                    .addHbarTransfer(fromAccount, new HashgraphSdk.Hbar(-1))
                    .addHbarTransfer(toAccount, new HashgraphSdk.Hbar(1))
                    .setNodeAccountIds([HashgraphSdk.AccountId.fromString("0.0.3")])
                    .setTransactionId(HashgraphSdk.TransactionId.generate(fromAccount));
                
                // Freeze the transaction
                const frozenTransaction = transferTransaction.freeze();
                
                // Execute the transaction
                const accountIds = hc.connectedAccountIds;
                if (accountIds && accountIds.length > 0) {
                    const result = await hc.sendTransaction(accountIds[0], frozenTransaction);
                    document.getElementById('transactionResult').innerHTML = 
                        `<div class="status success">Transaction sent! ID: ${result.response?.transactionId || 'Unknown'}</div>`;
                }
            } catch (error) {
                document.getElementById('transactionResult').innerHTML = 
                    `<div class="status error">Transaction failed: ${error.message}</div>`;
            }
        });

        // Set up event listeners
        hcInitPromise.then(() => {
            updateStatus('Ready! Click "Connect Wallet" to connect.', 'info');
            
            hc.pairingEvent.on((data) => {
                console.log('Paired:', data);
                updateStatus('Connected!', 'success');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                updateAccountInfo();
            });
            
            hc.disconnectionEvent.on(() => {
                console.log('Disconnected');
                updateStatus('Disconnected', 'info');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                updateAccountInfo();
            });
        }).catch(error => {
            updateStatus('Initialization failed: ' + error.message, 'error');
        });
    </script>
</body>
</html>
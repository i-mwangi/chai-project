<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vanilla JS HashConnect Example</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        h1, h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        h1 {
            font-size: 2rem;
        }

        h2 {
            font-size: 1.5rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-weight: 500;
        }

        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .disconnect-btn {
            background: #e74c3c;
        }

        .disconnect-btn:hover {
            background: #c0392b;
        }

        .account-info {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .account-info p {
            margin: 8px 0;
            font-size: 16px;
        }

        .account-info strong {
            color: #2c3e50;
        }

        .transaction-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
        }

        .error {
            border-left-color: #e74c3c;
            background: #fdf2f2;
            color: #721c24;
        }

        .success {
            border-left-color: #27ae60;
            background: #f2fdf2;
            color: #155724;
        }

        footer {
            text-align: center;
            padding: 20px;
            background: #ecf0f1;
            color: #7f8c8d;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ”— Vanilla JS HashConnect Integration</h1>
            <p>Example implementation without React or any framework</p>
        </header>
        
        <div class="content">
            <div class="section">
                <h2>Wallet Connection</h2>
                <div id="status" class="status info">
                    Ready to initialize. Click "Initialize HashConnect" below.
                </div>
                        
                <div style="text-align: center; margin: 20px 0;">
                    <button onclick="manualInitialize()">Initialize HashConnect</button>
                </div>
                
                <div id="accountInfo" class="account-info" style="display: none;">
                    <h3>Connected Wallet</h3>
                    <p><strong>Account ID:</strong> <span id="accountId">-</span></p>
                    <p><strong>Network:</strong> <span id="network">-</span></p>
                    <p><strong>Status:</strong> <span id="connectionStatus">-</span></p>
                </div>
                
                <div id="connectButtonContainer"></div>
                <div id="initButtonContainer">
                    <button onclick="initializeHashConnect()">Initialize HashConnect</button>
                </div>
                <div id="errorContainer"></div>
            </div>
            
            <div class="section">
                <h2>Transaction Demo</h2>
                <div class="transaction-section">
                    <div class="form-group">
                        <label for="fromAccount">From Account ID:</label>
                        <input type="text" id="fromAccount" placeholder="0.0.xxxxx" value="0.0.12345">
                    </div>
                    
                    <div class="form-group">
                        <label for="toAccount">To Account ID:</label>
                        <input type="text" id="toAccount" placeholder="0.0.yyyyy" value="0.0.67890">
                    </div>
                    
                    <button id="transferBtn" onclick="handleTransfer()" disabled>Send 1 HBAR Transfer</button>
                    
                    <div id="transactionResult"></div>
                </div>
            </div>
            
            <div class="section">
                <h2>About This Implementation</h2>
                <p>This example demonstrates how to use HashConnect with vanilla JavaScript without any frameworks like React or Vue.</p>
                <p>Key features:</p>
                <ul>
                    <li>Framework-agnostic HashConnect initialization</li>
                    <li>Simple state management with pub/sub pattern</li>
                    <li>DOM manipulation for UI updates</li>
                    <li>Transaction signing and execution</li>
                </ul>
            </div>
        </div>
        
        <footer>
            <p>HashConnect Vanilla JS Example | Project Chai Platform</p>
        </footer>
    </div>

    <!-- Polyfill for Buffer -->
    <script src="https://unpkg.com/buffer@6.0.3/index.js"></script>
    
    <!-- Hedera SDK -->
    <script src="https://unpkg.com/@hashgraph/sdk@2.41.0/dist/index.web.js"></script>
    
    <!-- HashConnect -->
    <script src="https://unpkg.com/hashconnect@3.0.13/dist/hashconnect.js"></script>
    
    <!-- Our custom modules -->
    <script type="module">
        // Import our modules
        import { hc, hcInitPromise, getConnectedAccountIds, executeTransaction } from './hashconnect.js';
        
        // Polyfill for Buffer
        window.Buffer = window.Buffer || buffer.Buffer;
        import { getState, setState, subscribe } from './state.js';
        import { createConnectButton } from './ui.js';
        import { handleTransfer as handleTransferLogic } from './transactions.js';

        // Set up Buffer polyfill
        window.Buffer = window.Buffer || buffer.Buffer;

        // Initialize HashConnect
        async function initializeHashConnect() {
            try {
                document.getElementById('status').textContent = 'Initializing HashConnect...';
                await hcInitPromise;
                document.getElementById('status').textContent = 'HashConnect initialized!';
                syncWithHashConnect();
                updateStatus('Ready! Click "Connect" to connect your wallet.', 'info');
            } catch (error) {
                console.error('HashConnect initialization failed:', error);
                updateStatus('Failed to initialize HashConnect: ' + error.message, 'disconnected');
            }
        }

        // Manual initialization function
        async function manualInitialize() {
            updateStatus('Initializing HashConnect... This may take a few seconds...', 'info');
            
            try {
                // Add timeout to initialization
                const initWithTimeout = Promise.race([
                    hcInitPromise,
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Initialization timeout - please check your internet connection and try again')), 15000)
                    )
                ]);
                
                await initWithTimeout;
                updateStatus('HashConnect initialized successfully!', 'success');
                syncWithHashConnect();
            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus('Initialization failed: ' + error.message, 'error');
            }
        }

        // Initialize the UI
        function init() {
            // Create and append the connect button
            const buttonContainer = document.getElementById('connectButtonContainer');
            const connectButton = createConnectButton();
            buttonContainer.appendChild(connectButton);

            // Subscribe to state changes
            subscribe(updateUI);

            // Initialize HashConnect
            hcInitPromise.then(() => {
                console.log('HashConnect initialized');
                syncWithHashConnect();
                updateStatus('Ready! Click "Connect" to connect your wallet.', 'info');
            }).catch(error => {
                console.error('HashConnect initialization failed:', error);
                updateStatus('Failed to initialize HashConnect: ' + error.message, 'disconnected');
            });
        }

        // Sync with HashConnect state
        function syncWithHashConnect() {
            const connectedAccountIds = getConnectedAccountIds();
            if (connectedAccountIds.length > 0) {
                setState({
                    accountIds: connectedAccountIds.map(o => o.toString()),
                    isConnected: true,
                    pairingString: hc.pairingString ?? ""
                });
            } else {
                setState({
                    accountIds: [],
                    isConnected: false,
                    pairingString: hc.pairingString ?? ""
                });
            }
        }

        // Update UI based on state
        function updateUI() {
            const { isConnected, accountIds } = getState();
            
            // Update account info display
            const accountInfoEl = document.getElementById('accountInfo');
            if (isConnected && accountIds.length > 0) {
                accountInfoEl.style.display = 'block';
                document.getElementById('accountId').textContent = accountIds[0];
                document.getElementById('network').textContent = 'testnet';
                document.getElementById('connectionStatus').textContent = 'Connected';
                
                // Enable transfer button
                document.getElementById('transferBtn').disabled = false;
            } else {
                accountInfoEl.style.display = 'none';
                document.getElementById('transferBtn').disabled = true;
            }
        }

        // Update status message
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
            console.log('Status update:', message, type);
        }

        // Handle transfer button click
        window.handleTransfer = async function() {
            const fromAccount = document.getElementById('fromAccount').value;
            const toAccount = document.getElementById('toAccount').value;
            
            if (!fromAccount || !toAccount) {
                alert('Please enter both account IDs');
                return;
            }
            
            const resultEl = document.getElementById('transactionResult');
            resultEl.innerHTML = '<div class="result">Processing transaction...</div>';
            
            try {
                const result = await handleTransferLogic(fromAccount, toAccount);
                resultEl.innerHTML = `
                    <div class="result success">
                        <h3>Transaction Successful!</h3>
                        <p><strong>Transaction ID:</strong> ${result.transactionId}</p>
                        <p>Status: ${result.receipt.status.toString()}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Transaction failed:', error);
                resultEl.innerHTML = `
                    <div class="result error">
                        <h3>Transaction Failed</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };

        // Set up HashConnect event listeners
        hcInitPromise.then(() => {
            hc.pairingEvent.on(() => {
                console.log('Pairing event received');
                syncWithHashConnect();
            });
            
            hc.disconnectionEvent.on(() => {
                console.log('Disconnection event received');
                syncWithHashConnect();
            });
            
            hc.connectionStatusChangeEvent.on(() => {
                console.log('Connection status changed');
                syncWithHashConnect();
            });
        });

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
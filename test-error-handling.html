<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Handling Test - Coffee Platform</title>
    <link rel="stylesheet" href="frontend/styles/main.css">
    <style>
        body {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #8B4513;
            margin-bottom: 1rem;
        }
        .test-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .test-btn {
            padding: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-error {
            background: #dc3545;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        .console-output .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-left: 3px solid #007acc;
        }
        .console-output .log-error {
            border-left-color: #dc3545;
        }
        .console-output .log-success {
            border-left-color: #28a745;
        }
    </style>
</head>
<body>
    <h1 style="color: #8B4513; margin-bottom: 2rem;">Error Handling System Test</h1>

    <div class="test-section">
        <h2>Custom Error Classes</h2>
        <p>Test different error types with specific properties</p>
        <div class="test-buttons">
            <button class="test-btn btn-error" onclick="testDistributionError()">
                Distribution Error
            </button>
            <button class="test-btn btn-error" onclick="testLoanError()">
                Loan Error
            </button>
            <button class="test-btn btn-error" onclick="testInsufficientBalance()">
                Insufficient Balance
            </button>
            <button class="test-btn btn-error" onclick="testNetworkError()">
                Network Error (Retry)
            </button>
            <button class="test-btn btn-error" onclick="testPriceOracleError()">
                Price Oracle Error
            </button>
            <button class="test-btn btn-error" onclick="testTokenOperationError()">
                Token Operation Error
            </button>
        </div>
    </div>

    <div class="test-section">
        <h2>Toast Notifications</h2>
        <p>Test different notification types</p>
        <div class="test-buttons">
            <button class="test-btn btn-success" onclick="testSuccessNotification()">
                Success Notification
            </button>
            <button class="test-btn btn-warning" onclick="testWarningNotification()">
                Warning Notification
            </button>
            <button class="test-btn btn-info" onclick="testInfoNotification()">
                Info Notification
            </button>
            <button class="test-btn btn-error" onclick="testMultipleToasts()">
                Multiple Toasts
            </button>
        </div>
    </div>

    <div class="test-section">
        <h2>Advanced Features</h2>
        <p>Test retry functionality and error recovery</p>
        <div class="test-buttons">
            <button class="test-btn btn-warning" onclick="testRetryFunctionality()">
                Test Retry Button
            </button>
            <button class="test-btn btn-info" onclick="testLongMessage()">
                Long Error Message
            </button>
            <button class="test-btn btn-error" onclick="testErrorWithContext()">
                Error with Context
            </button>
            <button class="test-btn btn-success" onclick="errorHandler.clearAll()">
                Clear All Toasts
            </button>
        </div>
    </div>

    <div class="test-section">
        <h2>Console Output</h2>
        <p>Check browser console for detailed error logs</p>
        <div class="console-output" id="consoleOutput">
            <div class="log-entry">Console output will appear here and in browser console...</div>
        </div>
    </div>

    <script src="frontend/js/errors.js"></script>
    <script src="frontend/js/error-handler.js"></script>
    <script>
        // Helper to log to both console and page
        function logToPage(message, type = 'info') {
            const output = document.getElementById('consoleOutput');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        // Test Distribution Error
        function testDistributionError() {
            try {
                const error = new DistributionError(
                    'Failed to process distribution batch',
                    'dist-12345',
                    ['0.0.123456', '0.0.789012']
                );
                throw error;
            } catch (error) {
                errorHandler.handleError(error, {
                    context: 'Revenue Distribution',
                    onRetry: () => {
                        logToPage('Retrying distribution...', 'info');
                        errorHandler.handleSuccess('Distribution retry successful!');
                    },
                    logToConsole: true
                });
                logToPage(`DistributionError thrown: ${error.message}`, 'error');
            }
        }

        // Test Loan Error
        function testLoanError() {
            try {
                const error = new LoanError(
                    'Insufficient collateral for loan',
                    'loan-67890',
                    'LOAN_INSUFFICIENT_COLLATERAL'
                );
                throw error;
            } catch (error) {
                errorHandler.handleError(error, {
                    context: 'Take Out Loan',
                    logToConsole: true
                });
                logToPage(`LoanError thrown: ${error.message}`, 'error');
            }
        }

        // Test Insufficient Balance Error
        function testInsufficientBalance() {
            try {
                const error = new InsufficientBalanceError(100, 45.50, 'USDC');
                throw error;
            } catch (error) {
                errorHandler.handleError(error, {
                    context: 'Withdraw Funds',
                    logToConsole: true
                });
                logToPage(`InsufficientBalanceError: Required ${error.required}, Available ${error.available}`, 'error');
            }
        }

        // Test Network Error with Retry
        function testNetworkError() {
            try {
                const error = new NetworkError(
                    'Connection timeout',
                    408,
                    '/api/lending/pools'
                );
                throw error;
            } catch (error) {
                errorHandler.handleError(error, {
                    context: 'Load Lending Pools',
                    onRetry: () => {
                        logToPage('Retrying network request...', 'info');
                        setTimeout(() => {
                            errorHandler.handleSuccess('Connection restored!');
                        }, 1000);
                    },
                    logToConsole: true
                });
                logToPage(`NetworkError thrown: ${error.message}`, 'error');
            }
        }

        // Test Price Oracle Error
        function testPriceOracleError() {
            try {
                const error = new PriceOracleError(
                    'Price data is stale',
                    'ARABICA',
                    'PRICE_STALE'
                );
                throw error;
            } catch (error) {
                errorHandler.handleError(error, {
                    context: 'Fetch Coffee Prices',
                    onRetry: () => {
                        logToPage('Refreshing price data...', 'info');
                        errorHandler.handleSuccess('Prices updated!');
                    },
                    logToConsole: true
                });
                logToPage(`PriceOracleError thrown for ${error.variety}`, 'error');
            }
        }

        // Test Token Operation Error
        function testTokenOperationError() {
            try {
                const error = new TokenOperationError(
                    'Only administrators can mint tokens',
                    'grove-001',
                    'UNAUTHORIZED'
                );
                throw error;
            } catch (error) {
                errorHandler.handleError(error, {
                    context: 'Mint Tokens',
                    logToConsole: true
                });
                logToPage(`TokenOperationError thrown for grove ${error.groveId}`, 'error');
            }
        }

        // Test Success Notification
        function testSuccessNotification() {
            errorHandler.handleSuccess('Operation completed successfully! 🎉');
            logToPage('Success notification shown', 'success');
        }

        // Test Warning Notification
        function testWarningNotification() {
            errorHandler.handleWarning('Your loan health factor is below 1.2. Consider adding collateral.');
            logToPage('Warning notification shown', 'info');
        }

        // Test Info Notification
        function testInfoNotification() {
            errorHandler.handleInfo('Refreshing price data from oracle...');
            logToPage('Info notification shown', 'info');
        }

        // Test Multiple Toasts
        function testMultipleToasts() {
            errorHandler.handleInfo('Loading data...');
            setTimeout(() => errorHandler.handleWarning('Connection slow...'), 500);
            setTimeout(() => errorHandler.handleError(new Error('Connection failed'), {
                context: 'Load Data',
                onRetry: () => errorHandler.handleSuccess('Retry successful!')
            }), 1000);
            logToPage('Multiple toasts triggered', 'info');
        }

        // Test Retry Functionality
        function testRetryFunctionality() {
            let attempts = 0;
            function attemptOperation() {
                attempts++;
                if (attempts < 3) {
                    const error = new NetworkError('Connection failed', null, '/api/test');
                    errorHandler.handleError(error, {
                        context: `Attempt ${attempts}`,
                        onRetry: attemptOperation,
                        logToConsole: true
                    });
                    logToPage(`Attempt ${attempts} failed`, 'error');
                } else {
                    errorHandler.handleSuccess('Operation succeeded after retries!');
                    logToPage('Operation succeeded', 'success');
                    attempts = 0;
                }
            }
            attemptOperation();
        }

        // Test Long Message
        function testLongMessage() {
            const error = new Error('This is a very long error message that demonstrates how the toast notification system handles lengthy text content. The message should wrap properly and remain readable even with multiple lines of text. The toast should expand to accommodate the content while maintaining good visual design.');
            errorHandler.handleError(error, {
                context: 'Long Message Test',
                logToConsole: true
            });
            logToPage('Long message error shown', 'error');
        }

        // Test Error with Context
        function testErrorWithContext() {
            const error = new ValidationError(
                'Amount must be greater than 0',
                'loanAmount',
                -50
            );
            errorHandler.handleError(error, {
                context: 'Loan Application Form',
                logToConsole: true
            });
            logToPage('Validation error with context shown', 'error');
        }

        // Log initial message
        logToPage('Error handling test page loaded. Click buttons to test different scenarios.', 'success');
    </script>
</body>
</html>

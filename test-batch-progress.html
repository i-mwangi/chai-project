<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Progress Test - Coffee Tree Platform</title>
    <link rel="stylesheet" href="frontend/styles/main.css">
    <style>
        body {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #8B4513;
            margin-bottom: 1rem;
        }
        .test-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #8B4513;
            color: white;
        }
        .btn-primary:hover {
            background: #A0522D;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .test-result {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #8B4513;
        }
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>ðŸš€ Batch Distribution Progress Test</h1>
    <p>This page tests the progress bar functionality for batch distribution operations.</p>

    <!-- Test Section 1: Basic Progress Bar -->
    <div class="test-section">
        <h2>1. Basic Progress Bar Test</h2>
        <p>Test the progress bar with different batch sizes.</p>
        <div class="test-buttons">
            <button class="btn btn-primary" onclick="testBasicProgress(10)">
                Small Batch (10 holders)
            </button>
            <button class="btn btn-primary" onclick="testBasicProgress(50)">
                Medium Batch (50 holders)
            </button>
            <button class="btn btn-primary" onclick="testBasicProgress(150)">
                Large Batch (150 holders)
            </button>
            <button class="btn btn-primary" onclick="testBasicProgress(500)">
                Extra Large (500 holders)
            </button>
        </div>
        <div id="basic-result" class="test-result" style="display: none;"></div>
    </div>

    <!-- Test Section 2: Distribution Batch Processing -->
    <div class="test-section">
        <h2>2. Distribution Batch Processing Simulation</h2>
        <p>Simulate actual distribution batch processing with progress tracking.</p>
        <div class="test-buttons">
            <button class="btn btn-success" onclick="testDistributionBatch(25)">
                Process 25 Holders
            </button>
            <button class="btn btn-success" onclick="testDistributionBatch(100)">
                Process 100 Holders
            </button>
            <button class="btn btn-success" onclick="testDistributionBatch(250)">
                Process 250 Holders
            </button>
        </div>
        <div class="stats-grid" id="distribution-stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total Holders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-successful">0</div>
                <div class="stat-label">Successful</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-failed">0</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-time">0s</div>
                <div class="stat-label">Processing Time</div>
            </div>
        </div>
        <div id="distribution-result" class="test-result" style="display: none;"></div>
    </div>

    <!-- Test Section 3: Real-time Progress Updates -->
    <div class="test-section">
        <h2>3. Real-time Progress Updates</h2>
        <p>Test progress bar with real-time updates showing "X of Y holders processed".</p>
        <div class="test-buttons">
            <button class="btn btn-primary" onclick="testRealtimeProgress(75)">
                Test with 75 Holders
            </button>
            <button class="btn btn-primary" onclick="testRealtimeProgress(200)">
                Test with 200 Holders
            </button>
        </div>
        <div id="realtime-result" class="test-result" style="display: none;"></div>
    </div>

    <!-- Test Section 4: Multiple Concurrent Batches -->
    <div class="test-section">
        <h2>4. Multiple Concurrent Batch Operations</h2>
        <p>Test multiple batch operations running simultaneously.</p>
        <div class="test-buttons">
            <button class="btn btn-success" onclick="testMultipleBatches()">
                Run 3 Concurrent Batches
            </button>
            <button class="btn btn-danger" onclick="clearAllProgress()">
                Clear All Progress
            </button>
        </div>
        <div id="multiple-result" class="test-result" style="display: none;"></div>
    </div>

    <!-- Test Section 5: Error Handling -->
    <div class="test-section">
        <h2>5. Progress with Errors</h2>
        <p>Test progress bar behavior when some transfers fail.</p>
        <div class="test-buttons">
            <button class="btn btn-primary" onclick="testProgressWithErrors(50, 0.1)">
                10% Failure Rate
            </button>
            <button class="btn btn-primary" onclick="testProgressWithErrors(50, 0.3)">
                30% Failure Rate
            </button>
        </div>
        <div id="error-result" class="test-result" style="display: none;"></div>
    </div>

    <script src="frontend/js/loading-states.js"></script>
    <script src="frontend/js/revenue-distribution.js"></script>
    <script>
        // Initialize loading state manager
        loadingStateManager.initialize();

        // Mock API client for testing
        const mockApiClient = {
            claimEarnings: async (distributionId, holderAddress) => {
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 50 + Math.random() * 50));
                
                // Simulate occasional failures (5% failure rate)
                if (Math.random() < 0.05) {
                    throw new Error('Network error');
                }
                
                return {
                    success: true,
                    transactionHash: '0x' + Math.random().toString(36).substring(2, 15)
                };
            }
        };

        // Create distribution manager instance
        const distributionManager = new RevenueDistributionManager(mockApiClient);

        // Test 1: Basic Progress Bar
        async function testBasicProgress(totalHolders) {
            const result = document.getElementById('basic-result');
            result.style.display = 'block';
            result.textContent = `Starting progress test with ${totalHolders} holders...\n`;

            const progressId = loadingStateManager.showProgress(`test-basic-${Date.now()}`, {
                message: 'Processing distribution batch...',
                total: totalHolders,
                current: 0
            });

            const startTime = Date.now();

            // Simulate processing
            for (let i = 1; i <= totalHolders; i++) {
                await new Promise(resolve => setTimeout(resolve, 20));
                
                const batchNum = Math.ceil(i / 50);
                const totalBatches = Math.ceil(totalHolders / 50);
                
                loadingStateManager.updateProgress(
                    progressId,
                    i,
                    `Processing batch ${batchNum} of ${totalBatches}... (${i} of ${totalHolders} holders)`
                );
            }

            const duration = ((Date.now() - startTime) / 1000).toFixed(2);

            // Keep progress bar visible for a moment
            await new Promise(resolve => setTimeout(resolve, 1000));

            loadingStateManager.hideProgress(progressId);
            result.textContent += `\nâœ“ Completed! Processed ${totalHolders} holders in ${duration}s`;
        }

        // Test 2: Distribution Batch Processing
        async function testDistributionBatch(totalHolders) {
            const result = document.getElementById('distribution-result');
            const statsDiv = document.getElementById('distribution-stats');
            result.style.display = 'block';
            statsDiv.style.display = 'grid';
            result.textContent = `Starting distribution batch processing for ${totalHolders} holders...\n`;

            // Generate mock holders
            const holders = [];
            for (let i = 0; i < totalHolders; i++) {
                holders.push({
                    address: `0.0.${1000 + i}`,
                    tokenBalance: Math.floor(Math.random() * 1000) + 100,
                    shareAmount: Math.floor(Math.random() * 500) + 50
                });
            }

            const startTime = Date.now();

            // Update stats
            document.getElementById('stat-total').textContent = totalHolders;
            document.getElementById('stat-successful').textContent = '0';
            document.getElementById('stat-failed').textContent = '0';
            document.getElementById('stat-time').textContent = '0s';

            // Process batch with progress tracking
            const batchResult = await distributionManager.processDistributionBatch(
                `dist-${Date.now()}`,
                holders,
                50,
                loadingStateManager
            );

            const duration = ((Date.now() - startTime) / 1000).toFixed(2);

            // Update final stats
            document.getElementById('stat-successful').textContent = batchResult.successfulTransfers;
            document.getElementById('stat-failed').textContent = batchResult.failedTransfers;
            document.getElementById('stat-time').textContent = duration + 's';

            result.textContent += `\nâœ“ Distribution completed!`;
            result.textContent += `\n  Total holders: ${batchResult.totalHolders}`;
            result.textContent += `\n  Successful: ${batchResult.successfulTransfers}`;
            result.textContent += `\n  Failed: ${batchResult.failedTransfers}`;
            result.textContent += `\n  Duration: ${duration}s`;
            result.textContent += `\n  Success rate: ${((batchResult.successfulTransfers / batchResult.totalHolders) * 100).toFixed(1)}%`;
        }

        // Test 3: Real-time Progress Updates
        async function testRealtimeProgress(totalHolders) {
            const result = document.getElementById('realtime-result');
            result.style.display = 'block';
            result.textContent = `Testing real-time progress updates with ${totalHolders} holders...\n`;

            const progressId = loadingStateManager.showProgress(`test-realtime-${Date.now()}`, {
                message: 'Initializing distribution...',
                total: totalHolders,
                current: 0
            });

            const batchSize = 50;
            const totalBatches = Math.ceil(totalHolders / batchSize);

            for (let i = 1; i <= totalHolders; i++) {
                await new Promise(resolve => setTimeout(resolve, 30));
                
                const currentBatch = Math.ceil(i / batchSize);
                const progressInBatch = i % batchSize || batchSize;
                
                loadingStateManager.updateProgress(
                    progressId,
                    i,
                    `Batch ${currentBatch}/${totalBatches}: Processing holder ${progressInBatch}/${Math.min(batchSize, totalHolders - (currentBatch - 1) * batchSize)}`
                );

                // Log progress at intervals
                if (i % 25 === 0 || i === totalHolders) {
                    result.textContent += `\n[${new Date().toLocaleTimeString()}] Processed ${i}/${totalHolders} holders (${Math.round((i/totalHolders)*100)}%)`;
                }
            }

            await new Promise(resolve => setTimeout(resolve, 1000));
            loadingStateManager.hideProgress(progressId);
            result.textContent += `\n\nâœ“ Real-time progress test completed!`;
        }

        // Test 4: Multiple Concurrent Batches
        async function testMultipleBatches() {
            const result = document.getElementById('multiple-result');
            result.style.display = 'block';
            result.textContent = 'Starting 3 concurrent batch operations...\n';

            const batches = [
                { id: 'batch-1', total: 50, delay: 40 },
                { id: 'batch-2', total: 75, delay: 30 },
                { id: 'batch-3', total: 100, delay: 25 }
            ];

            const promises = batches.map(async (batch) => {
                const progressId = loadingStateManager.showProgress(batch.id, {
                    message: `Processing ${batch.id}...`,
                    total: batch.total,
                    current: 0
                });

                for (let i = 1; i <= batch.total; i++) {
                    await new Promise(resolve => setTimeout(resolve, batch.delay));
                    loadingStateManager.updateProgress(
                        progressId,
                        i,
                        `${batch.id}: ${i} of ${batch.total} holders`
                    );
                }

                await new Promise(resolve => setTimeout(resolve, 500));
                loadingStateManager.hideProgress(progressId);
                result.textContent += `\nâœ“ ${batch.id} completed (${batch.total} holders)`;
            });

            await Promise.all(promises);
            result.textContent += `\n\nâœ“ All concurrent batches completed!`;
        }

        // Test 5: Progress with Errors
        async function testProgressWithErrors(totalHolders, failureRate) {
            const result = document.getElementById('error-result');
            result.style.display = 'block';
            result.textContent = `Testing with ${totalHolders} holders and ${(failureRate * 100).toFixed(0)}% failure rate...\n`;

            const progressId = loadingStateManager.showProgress(`test-errors-${Date.now()}`, {
                message: 'Processing distribution with potential errors...',
                total: totalHolders,
                current: 0
            });

            let successful = 0;
            let failed = 0;

            for (let i = 1; i <= totalHolders; i++) {
                await new Promise(resolve => setTimeout(resolve, 40));
                
                // Simulate success or failure
                if (Math.random() < failureRate) {
                    failed++;
                } else {
                    successful++;
                }
                
                loadingStateManager.updateProgress(
                    progressId,
                    i,
                    `Processing: ${successful} successful, ${failed} failed`
                );
            }

            await new Promise(resolve => setTimeout(resolve, 1000));
            loadingStateManager.hideProgress(progressId);
            
            result.textContent += `\nâœ“ Processing completed!`;
            result.textContent += `\n  Total: ${totalHolders}`;
            result.textContent += `\n  Successful: ${successful} (${((successful/totalHolders)*100).toFixed(1)}%)`;
            result.textContent += `\n  Failed: ${failed} (${((failed/totalHolders)*100).toFixed(1)}%)`;
        }

        // Clear all progress bars
        function clearAllProgress() {
            loadingStateManager.clearAll();
            const result = document.getElementById('multiple-result');
            result.style.display = 'block';
            result.textContent = 'All progress bars cleared!';
        }

        // Log active operations
        setInterval(() => {
            const count = loadingStateManager.getActiveOperationCount();
            if (count > 0) {
                console.log(`Active operations: ${count}`);
            }
        }, 1000);
    </script>
</body>
</html>
